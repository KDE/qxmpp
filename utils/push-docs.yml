# SPDX-FileCopyrightText: 2026 Linus Jahn <lnj@kaidan.im>
#
# SPDX-License-Identifier: CC0-1.0

push_documentation:
  stage: validate
  image: alpine:latest
  before_script:
    - apk add --no-cache git cmake make doxygen graphviz g++ qt6-qtbase-dev
    - git config --global user.email "noreply@qxmpp.org"
    - git config --global user.name "QXmpp CI Bot"
  script:
    # Generate documentation
    - mkdir build && cd build
    - cmake .. -DBUILD_DOCUMENTATION=ON -DWITH_QCA=OFF
    - cmake --build . --target doc
    - cp -r doc/html ../documentation_output
    # Switch branch and add a remote using the CI_JOB_TOKEN
    - git fetch origin work/doc-qxmpp-org:work/doc-qxmpp-org
    - git checkout work/doc-qxmpp-org
    - git remote set-url origin https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
    - echo "Updated by CI" > file.txt
    - mv ../documentation_output qxmpp-dev
    - git add qxmpp-dev
    - git commit -m "Update documentation for commit ${CI_COMMIT_SHA}"
    - echo "Pushing to work/doc-qxmpp-org branchâ€¦"
    - git push origin work/doc-qxmpp-org
  rules:
    - if: $CI_COMMIT_BRANCH == 'work/lnj/doc-push'

